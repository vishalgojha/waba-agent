<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WABA Gateway Mission Control</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111827;
      --panel-soft: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --line: #1f2937;
      --brand: #3b82f6;
      --brand-2: #2563eb;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
    }
    html.dark {
      --bg: #060913;
      --panel: #0f1629;
      --panel-soft: #0b1220;
      --line: #1b2438;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at 10% 0%, #111a32, var(--bg) 40%);
      color: var(--text);
      min-height: 100vh;
    }
    .layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }
    .side {
      border-right: 1px solid var(--line);
      background: rgba(6, 10, 20, 0.75);
      backdrop-filter: blur(8px);
      padding: 18px;
      display: grid;
      grid-template-rows: auto auto auto 1fr;
      gap: 14px;
      min-height: 0;
    }
    .brand h1 { margin: 0; font-size: 20px; }
    .sub { color: var(--muted); font-size: 12px; }
    .controls { display: grid; gap: 10px; }
    .controls label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; }
    .controls input, .controls select, textarea, #configSnapshot {
      width: 100%; border: 1px solid var(--line); border-radius: 10px;
      background: var(--panel-soft); color: var(--text); padding: 10px;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    button {
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 10px 12px;
      background: var(--panel-soft);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { filter: brightness(1.08); }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .btnPrimary { background: linear-gradient(135deg, var(--brand), var(--brand-2)); }
    .btnGhost { border-color: var(--line); }
    .main {
      display: grid;
      grid-template-rows: auto auto auto minmax(0, 1fr);
      min-height: 0;
    }
    .top {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: rgba(6,10,20,.45);
    }
    .top .title { font-size: 18px; font-weight: 700; }
    .topActions { display: flex; gap: 8px; align-items: center; }
    .theme-toggle { width: 38px; height: 38px; }
    .statusBar {
      margin: 14px 18px 0;
      padding: 12px 14px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 10px;
    }
    .statusItem { min-width: 0; }
    .statusItem .k { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .06em; }
    .statusItem .v { margin-top: 6px; font-weight: 700; }
    .tabs { display: flex; gap: 8px; padding: 14px 18px 10px; }
    .tab { border: 1px solid var(--line); background: var(--panel); }
    .tab.active { background: linear-gradient(135deg, var(--brand), var(--brand-2)); border-color: transparent; }
    .view { display: none; min-height: 0; }
    .view.active { display: grid; min-height: 0; }
    #viewDashboard { padding: 0 18px 18px; gap: 12px; grid-template-columns: 1.1fr .9fr; }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      min-height: 0;
    }
    .card h3 { margin: 0 0 10px; font-size: 14px; }
    #sessionListDashboard, #sessionList, #campaignList, #actionList { overflow: auto; min-height: 0; }
    .sessionItem {
      padding: 9px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      margin-bottom: 8px;
      background: var(--panel-soft);
      cursor: pointer;
    }
    #viewChat { padding: 0 18px 18px; grid-template-rows: minmax(0,1fr) auto; gap: 12px; overflow: hidden; }
    .chatGrid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 12px; min-height: 0; overflow: hidden; }
    #chatLog {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      overflow: auto;
      min-height: 260px;
    }
    .msgWrap { display:flex; margin:8px 0; }
    .msgWrap.user { justify-content:flex-end; }
    .msg { max-width: 88%; padding:10px 12px; border-radius: 12px; line-height:1.4; }
    .msg.agent { background: var(--panel-soft); border: 1px solid var(--line); }
    .msg.user { background: linear-gradient(135deg, var(--brand), var(--brand-2)); color: #fff; }
    #actionsBox { min-height: 0; overflow: auto; }
    .actionRow {
      display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
      border: 1px solid var(--line); border-radius: 10px; padding: 8px; margin-bottom: 8px;
      background: var(--panel-soft);
    }
    .risk { padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .risk.high { background: rgba(239,68,68,.15); color: #fca5a5; }
    .risk.medium { background: rgba(245,158,11,.15); color: #fcd34d; }
    .risk.low { background: rgba(34,197,94,.15); color: #86efac; }
    .composer {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 10px;
    }
    #quickChips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      border: 1px solid var(--line);
      background: var(--panel-soft);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .composerRow { display:grid; grid-template-columns: 1fr auto; gap:8px; }
    #msgInput { min-height: 60px; max-height: 180px; resize: vertical; }
    #viewCampaigns, #viewSettings { padding: 0 18px 18px; }
    .stack { display: grid; gap: 12px; }
    .empty { color: var(--muted); border: 1px dashed var(--line); border-radius: 10px; padding: 10px; }
    #toasts { position: fixed; right: 14px; bottom: 14px; display:grid; gap:8px; z-index: 20; }
    .toast { background: var(--panel); border: 1px solid var(--line); border-radius: 10px; padding: 10px 12px; }
    .toast.ok { border-color: rgba(34,197,94,.35); }
    .toast.warn { border-color: rgba(245,158,11,.35); }
    .toast.err { border-color: rgba(239,68,68,.35); }
    .skeleton { color: transparent !important; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 11px; color: var(--muted); }
    @media (max-width: 1100px) {
      .layout { grid-template-columns: 1fr; }
      .side { border-right: 0; border-bottom: 1px solid var(--line); }
      .statusBar { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .chatGrid { grid-template-columns: 1fr; }
      #viewDashboard { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="side">
      <div class="brand">
        <h1>WABA Gateway</h1>
        <div class="sub">Mission control</div>
      </div>
      <div class="controls">
        <div>
          <label>Client</label>
          <input id="clientInput" value="acme-realty" />
        </div>
        <div>
          <label>Language</label>
          <select id="langInput">
            <option value="en" selected>English</option>
            <option value="hi">Hindi/English</option>
          </select>
        </div>
        <div class="row">
          <button class="btnPrimary" id="startBtn">Start Session</button>
          <button class="btnGhost" id="refreshBtn">Refresh</button>
        </div>
      </div>
      <div class="controls">
        <label><input id="allowHighRisk" type="checkbox" /> Allow high-risk execute</label>
        <button class="btnGhost" id="magicToggleBtn">Magic Mode: OFF</button>
        <button class="btnGhost" id="importResaleBtn">Import Resale Leads</button>
      </div>
      <div class="card" style="padding:10px;">
        <h3>Recent Sessions</h3>
        <div id="sessionList"></div>
      </div>
    </aside>

    <main class="main">
      <div class="top">
        <div class="title">Control Room</div>
        <div class="topActions">
          <button class="chip" id="quickMetaLaunchTopBtn" type="button">Get Tokens</button>
          <button class="theme-toggle btnGhost" type="button">?</button>
          <div id="sessionBadge" class="mono">No session</div>
        </div>
      </div>

      <section class="statusBar">
        <div class="statusItem"><div class="k">Missed</div><div class="v" id="dMissed">-</div></div>
        <div class="statusItem"><div class="k">Inbound</div><div class="v" id="dLeads">-</div></div>
        <div class="statusItem"><div class="k">Avg Resp</div><div class="v" id="dResp">-</div></div>
        <div class="statusItem"><div class="k">Re-engaged</div><div class="v" id="dReengaged">-</div></div>
        <div class="statusItem"><div class="k">Gateway</div><div class="v" id="gatewayHealth">Unknown</div></div>
        <div class="statusItem"><div class="k">Webhook</div><div class="v" id="webhookUrl">Not set</div></div>
      </section>

      <div class="tabs">
        <button class="tab active" data-view="dashboard">Dashboard</button>
        <button class="tab" data-view="chat">Chat</button>
        <button class="tab" data-view="campaigns">Campaigns</button>
        <button class="tab" data-view="settings">Settings</button>
      </div>

      <section class="view active" id="viewDashboard">
        <div class="card stack">
          <h3>Quick Actions</h3>
          <div class="row">
            <button class="btnPrimary" id="openChatBtn">Open Chat</button>
            <button class="btnGhost" id="openCampaignsBtn">Open Campaigns</button>
          </div>
          <div class="row">
            <button class="btnGhost" id="openSettingsBtn">Open Settings</button>
            <button class="btnGhost" id="refreshDashBtn">Refresh Health</button>
          </div>
          <div class="row">
            <button class="btnGhost" id="quickMetaLaunchBtn">Get Meta Tokens</button>
            <button class="btnGhost" id="quickMetaCmdBtn">Copy Meta CLI</button>
          </div>
          <button class="btnGhost" id="shareWinBtn">Share this win</button>
        </div>
        <div class="card stack">
          <h3>Live Activity</h3>
          <div id="sessionListDashboard"></div>
          <h3>Config Snapshot</h3>
          <textarea id="configSnapshot" rows="8"></textarea>
          <button class="btnGhost" id="reloadSettingsBtn">Reload Settings</button>
        </div>
      </section>

      <section class="view" id="viewChat">
        <div class="chatGrid">
          <section id="chatLog"></section>
          <section class="card" id="actionsBox">
            <h3 style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <span>Proposed Actions</span>
              <span class="mono" id="queueCount">0 pending</span>
            </h3>
            <div id="actionList"></div>
            <div class="row">
              <button class="btnPrimary" id="execAllBtn" disabled>Execute All</button>
              <button class="btnGhost" id="clearActionsBtn">Clear</button>
            </div>
          </section>
        </div>
        <section class="composer">
          <div id="quickChips"></div>
          <div class="row">
            <button class="chip" id="openMetaAppBtn" type="button">Meta App</button>
            <button class="chip" id="openMetaApiBtn" type="button">API Setup</button>
          </div>
          <div class="composerRow">
            <textarea id="msgInput" placeholder="Try: whoami | show templates | send welcome text to +919812345678"></textarea>
            <button class="btnPrimary" id="sendBtn">Send</button>
          </div>
        </section>
      </section>

      <section class="view" id="viewCampaigns">
        <div class="stack">
          <div class="card stack">
            <h3>Create Campaign</h3>
            <input id="campaignName" placeholder="Campaign name" />
            <input id="campaignTemplate" placeholder="Template name" />
            <input id="campaignRecipients" placeholder="Recipients comma-separated" />
            <input id="campaignSchedule" type="datetime-local" />
            <button class="btnPrimary" id="createCampaignBtn">Create</button>
          </div>
          <div class="card">
            <h3>Campaigns</h3>
            <div id="campaignList"></div>
          </div>
        </div>
      </section>

      <section class="view" id="viewSettings">
        <div class="stack">
          <div class="card stack">
            <h3>Meta Credentials</h3>
            <input id="metaToken" type="password" placeholder="Access token" />
            <input id="metaPhoneId" placeholder="Phone number ID" />
            <input id="metaWabaId" placeholder="WABA ID" />
            <div id="metaTokenHint" class="mono">No token saved</div>
            <div class="row">
              <button class="btnPrimary" id="saveMetaBtn">Save</button>
              <button class="btnGhost" id="reloadMetaBtn">Reload</button>
            </div>
          </div>
          <div class="card stack">
            <h3>Meta Resources</h3>
            <button class="btnGhost" id="openMetaBizBtn">Business Settings</button>
            <button class="btnGhost" id="copyMetaCmdBtn">Copy CLI Cmd</button>
            <div style="border:1px solid var(--line); border-radius:10px; padding:10px; background:var(--panel-soft);">
              <div style="font-weight:700; margin-bottom:6px;">How to enable AI (Ollama) - simple steps</div>
              <div class="mono" style="line-height:1.6;">
                1) Open Ollama app on your computer.<br/>
                2) In this page set Provider = <strong>Ollama (Local)</strong>.<br/>
                3) Keep Base URL as <strong>http://127.0.0.1:11434/v1</strong>.<br/>
                4) Model: <strong>deepseek-coder-v2:16b</strong> (or any model you installed).<br/>
                5) Click <strong>Save AI Pref</strong>.<br/>
                6) Go to Chat and send: <strong>whoami</strong> or <strong>show templates</strong>.
              </div>
              <div class="mono" style="line-height:1.6; margin-top:8px;">
                OpenRouter option: set Provider = <strong>OpenRouter</strong>, paste API Key,<br/>
                Base URL = <strong>https://openrouter.ai/api/v1</strong>, Model = e.g. <strong>openai/gpt-4o-mini</strong>.
              </div>
            </div>
            <button class="btnGhost" id="saveAiBtn">Save AI Pref</button>
            <select id="aiProvider">
              <option value="openai">OpenAI Compatible</option>
              <option value="ollama">Ollama (Local)</option>
              <option value="anthropic">Anthropic</option>
              <option value="xai">xAI</option>
              <option value="openrouter">OpenRouter</option>
            </select>
            <input id="aiApiKey" type="password" placeholder="API Key (required for OpenRouter/OpenAI/Anthropic/xAI)" />
            <input id="aiBaseUrl" value="http://127.0.0.1:11434/v1" placeholder="AI Base URL" />
            <input id="aiModel" value="deepseek-coder-v2:16b" />
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toasts"></div>

  <div id="compatGhost" style="display:none" aria-hidden="true">
    <span id="sMissed">-</span><span id="sLeads">-</span><span id="sResp">-</span><span id="sReengaged">-</span><span id="sQualified">-</span>
  </div>

<script>
      const HIGH_RISK = new Set(["message.send_text", "template.send", "schedule.add_text", "schedule.add_template", "lead.schedule_followup", "lead.escalate_human"]);
      const MEDIUM_RISK = new Set(["lead.tag", "schedule.run_due"]);

      const state = {
        sessionId: null,
        actions: [],
        view: "dashboard",
        resale: {
          magicEnabled: false,
          share: null
        },
        campaigns: [],
        req: {
          summary: 0,
          sessions: 0
        },
        busy: {
          start: false,
          send: false,
          execute: false
        }
      };

      const META_TOKEN_URL = "https://business.facebook.com/latest/settings/system_users";
      const META_APP_URL = "https://developers.facebook.com/apps/";
      const $ = (id) => document.getElementById(id);
      const chatLog = $("chatLog");
      try {
        const themeBtn = document.querySelector(".theme-toggle");
        if (localStorage.getItem("theme") === "dark") {
          document.documentElement.classList.add("dark");
        }
        if (themeBtn) {
          themeBtn.onclick = () => {
            document.documentElement.classList.toggle("dark");
            localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
          };
        }
      } catch {}

      function toast(type, message) {
        const host = $("toasts");
        const el = document.createElement("div");
        el.className = "toast " + (type || "ok");
        el.textContent = String(message || "");
        host.appendChild(el);
        setTimeout(() => {
          el.style.opacity = "0";
          setTimeout(() => el.remove(), 200);
        }, 3000);
      }

      function setBusy(button, isBusy, busyLabel) {
        if (!button) return;
        if (isBusy) {
          if (!button.dataset.label) button.dataset.label = button.textContent;
          button.disabled = true;
          if (busyLabel) button.textContent = busyLabel;
          return;
        }
        button.disabled = false;
        if (button.dataset.label) button.textContent = button.dataset.label;
      }

      function withSkeleton(ids, on) {
        for (const id of ids) {
          const node = $(id);
          if (!node) continue;
          if (on) node.classList.add("skeleton");
          else node.classList.remove("skeleton");
        }
      }

      function escapeHtml(s) {
        return String(s || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      async function api(url, options = {}) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), Number(options.timeoutMs || 30000));
        try {
          const res = await fetch(url, {
            method: options.method || "GET",
            headers: { "Content-Type": "application/json", ...(options.headers || {}) },
            body: options.body ? JSON.stringify(options.body) : undefined,
            signal: controller.signal
          });
          const raw = await res.text();
          let data = {};
          try {
            data = raw ? JSON.parse(raw) : {};
          } catch {
            data = { raw };
          }
          if (!res.ok) {
            throw new Error(String(data?.error || data?.message || raw || ("HTTP " + res.status)));
          }
          return data;
        } finally {
          clearTimeout(timeout);
        }
      }

      function addMessage(role, content) {
        const wrap = document.createElement("div");
        wrap.className = "msgWrap " + (role === "user" ? "user" : "agent");
        const bubble = document.createElement("div");
        bubble.className = "msg " + (role === "user" ? "user" : "agent");
        bubble.innerHTML = escapeHtml(content).replace(/\n/g, "<br/>");
        wrap.appendChild(bubble);
        chatLog.appendChild(wrap);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function clearChatWithEmpty(text) {
        chatLog.innerHTML = "<div class='empty'>" + escapeHtml(text) + "</div>";
      }

      function setSessionBadge() {
        $("sessionBadge").textContent = state.sessionId ? ("Session " + state.sessionId) : "No session";
      }

      function setView(view) {
        state.view = view;
        const map = {
          dashboard: "viewDashboard",
          chat: "viewChat",
          campaigns: "viewCampaigns",
          settings: "viewSettings"
        };
        for (const [name, id] of Object.entries(map)) {
          $(id).classList.toggle("active", name === view);
        }
        for (const btn of document.querySelectorAll(".tab")) {
          btn.classList.toggle("active", btn.dataset.view === view);
        }
        if (view === "campaigns") refreshCampaigns().catch((err) => toast("err", err.message));
        if (view === "settings") refreshSettings().catch((err) => toast("err", err.message));
      }

      function actionRisk(action) {
        const tool = String(action?.tool || action?.fn || action?.action || "");
        if (HIGH_RISK.has(tool)) return "high";
        if (MEDIUM_RISK.has(tool)) return "medium";
        return "low";
      }

      function normalizeActions(payload) {
        if (Array.isArray(payload?.pending_actions)) return payload.pending_actions;
        if (Array.isArray(payload?.response?.actions)) return payload.response.actions;
        if (Array.isArray(payload?.actions)) return payload.actions;
        return [];
      }

      async function approveAction(actionId, btn) {
        if (!state.sessionId || !actionId) return;
        setBusy(btn, true, "Approving...");
        try {
          const out = await api("/api/session/" + encodeURIComponent(state.sessionId) + "/execute", {
            method: "POST",
            body: { actionId, allowHighRisk: $("allowHighRisk").checked }
          });
          const e = out.execution || {};
          state.actions = Array.isArray(out.pending_actions) ? out.pending_actions : [];
          renderActions();
          toast("ok", "Approved: ok=" + Number(e.ok || 0) + ", failed=" + Number(e.failed || 0));
          await refreshSummary();
        } catch (err) {
          toast("err", "Approve failed: " + err.message);
        } finally {
          setBusy(btn, false);
        }
      }

      async function rejectAction(actionId, btn) {
        if (!state.sessionId || !actionId) return;
        setBusy(btn, true, "Rejecting...");
        try {
          const out = await api("/api/session/" + encodeURIComponent(state.sessionId) + "/reject", {
            method: "POST",
            body: { actionId }
          });
          state.actions = Array.isArray(out.pending_actions) ? out.pending_actions : [];
          renderActions();
          toast("warn", "Rejected action " + actionId);
          await refreshSummary();
        } catch (err) {
          toast("err", "Reject failed: " + err.message);
        } finally {
          setBusy(btn, false);
        }
      }

      function renderActions() {
        const box = $("actionsBox");
        const list = $("actionList");
        const execBtn = $("execAllBtn");
        list.innerHTML = "";
        $("queueCount").textContent = state.actions.length + " pending";
        if (!state.actions.length) {
          box.style.display = "block";
          if (execBtn) execBtn.disabled = true;
          list.innerHTML = "<div class='empty'>No pending actions yet. Send a chat message to generate tool actions.</div>";
          return;
        }
        box.style.display = "block";
        if (execBtn) execBtn.disabled = false;
        for (const a of state.actions) {
          const row = document.createElement("div");
          row.className = "actionRow";
          const id = String(a?.id || a?.action_id || "");
          const risk = actionRisk(a);
          row.innerHTML = "<div><div class='desc'>" + escapeHtml(a.description || a.tool || "Pending action") + "</div><div class='mono'>" +
            escapeHtml(String(a.tool || a.fn || "tool.unknown")) + (id ? (" | id " + escapeHtml(id)) : "") + "</div></div>" +
            "<span class='risk " + risk + "'>" + risk.toUpperCase() + " RISK</span>";
          const buttons = document.createElement("div");
          buttons.className = "actionButtons";
          const approve = document.createElement("button");
          approve.className = "btnPrimary";
          approve.textContent = "Approve";
          approve.disabled = !id;
          approve.onclick = () => approveAction(id, approve);
          const reject = document.createElement("button");
          reject.className = "btnGhost";
          reject.textContent = "Reject";
          reject.disabled = !id;
          reject.onclick = () => rejectAction(id, reject);
          buttons.appendChild(approve);
          buttons.appendChild(reject);
          row.appendChild(buttons);
          list.appendChild(row);
        }
      }

      function renderSuggestions(suggestions) {
        const chips = $("quickChips");
        chips.innerHTML = "";
        for (const s of suggestions || []) {
          const b = document.createElement("button");
          b.className = "chip";
          b.textContent = s;
          b.onclick = () => {
            $("msgInput").value = s;
            sendMessage().catch((err) => toast("err", err.message));
          };
          chips.appendChild(b);
        }
      }

      async function startSession({ sessionId = null, language = null } = {}) {
        if (state.busy.start) return;
        state.busy.start = true;
        setBusy($("startBtn"), true, "Starting...");
        const client = $("clientInput").value.trim() || "default";
        const lang = language || $("langInput").value || "en";
        try {
          const data = await api("/api/session/start", {
            method: "POST",
            body: { client, language: lang, sessionId: sessionId || undefined }
          });
          state.sessionId = data.session?.id || data.session_id;
          setSessionBadge();
          chatLog.innerHTML = "";
          const messages = Array.isArray(data.messages) ? data.messages : (data.session?.context?.messages || []);
          if (messages.length) {
            for (const m of messages) addMessage(m.role, m.content);
          } else {
            addMessage("agent", data.greeting || "Session ready.");
          }
          state.actions = normalizeActions(data);
          renderActions();
          await Promise.all([refreshSummary(), refreshSessions()]);
          toast("ok", "Session ready.");
        } finally {
          state.busy.start = false;
          setBusy($("startBtn"), false);
        }
      }

      async function sendMessage() {
        if (state.busy.send) return;
        const msg = $("msgInput").value.trim();
        if (!msg) return;
        if (!state.sessionId) await startSession();
        if (!state.sessionId) return;
        state.busy.send = true;
        setBusy($("sendBtn"), true, "Sending...");
        addMessage("user", msg);
        $("msgInput").value = "";
        const allowHighRisk = $("allowHighRisk").checked;
        try {
          const out = await api("/api/session/" + encodeURIComponent(state.sessionId) + "/message", {
            method: "POST",
            body: { message: msg, autoExecute: false, allowHighRisk }
          });
          addMessage("agent", out.response?.message || out.reply || "Done.");
          state.actions = normalizeActions(out);
          renderActions();
          renderSuggestions(out.response?.suggestions || []);
          await Promise.all([refreshSummary(), refreshSessions()]);
        } finally {
          state.busy.send = false;
          setBusy($("sendBtn"), false);
        }
      }

      async function executeAll() {
        if (state.busy.execute) return;
        if (!state.sessionId || !state.actions.length) {
          toast("warn", "No pending actions to execute.");
          return;
        }
        state.busy.execute = true;
        setBusy($("execAllBtn"), true, "Executing...");
        const allowHighRisk = $("allowHighRisk").checked;
        try {
          const out = await api("/api/session/" + encodeURIComponent(state.sessionId) + "/execute", {
            method: "POST",
            body: { actions: state.actions, allowHighRisk }
          });
          addMessage("agent", "Execution complete: " + out.execution.ok + " ok, " + out.execution.failed + " failed.");
          state.actions = Array.isArray(out.pending_actions) ? out.pending_actions : [];
          renderActions();
          await refreshSummary();
          toast("ok", "Execution completed.");
        } finally {
          state.busy.execute = false;
          setBusy($("execAllBtn"), false);
        }
      }

      async function refreshSummary() {
        const ticket = ++state.req.summary;
        const client = $("clientInput").value.trim() || "default";
        withSkeleton(["sMissed", "sLeads", "sResp", "sReengaged", "sQualified", "dMissed", "dLeads", "dResp", "dReengaged"], true);
        try {
          const summary = await api("/api/summary?client=" + encodeURIComponent(client) + "&days=30");
          if (ticket !== state.req.summary) return;
          const missed = String(summary.missedLeads || 0);
          const leads = String(summary.metrics?.leads?.inboundMessages ?? "-");
          const avg = summary.metrics?.responses?.avgMinutes;
          const resp = Number.isFinite(avg) ? (avg.toFixed(1) + "m") : "-";
          const rm = summary.resale_metrics || {};
          const reengaged = String(rm.contacts_reengaged ?? "-");
          const qualified = String(rm.qualified_leads ?? "-");

          $("sMissed").textContent = missed;
          $("sLeads").textContent = leads;
          $("sResp").textContent = resp;
          $("sReengaged").textContent = reengaged;
          $("sQualified").textContent = qualified;

          $("dMissed").textContent = missed;
          $("dLeads").textContent = leads;
          $("dResp").textContent = resp;
          $("dReengaged").textContent = reengaged;
          state.resale.magicEnabled = summary.resale_magic_mode === true;
          $("magicToggleBtn").textContent = state.resale.magicEnabled ? "Magic Mode: ON" : "Magic Mode: OFF";
          if (state.resale.magicEnabled) {
            const win = await api("/api/resale/metrics?client=" + encodeURIComponent(client) + "&hours=48").catch(() => null);
            if (ticket === state.req.summary) state.resale.share = win?.share || null;
          } else {
            state.resale.share = null;
          }
        } finally {
          if (ticket === state.req.summary) {
            withSkeleton(["sMissed", "sLeads", "sResp", "sReengaged", "sQualified", "dMissed", "dLeads", "dResp", "dReengaged"], false);
          }
        }
      }

      async function toggleMagicMode() {
        const client = $("clientInput").value.trim() || "default";
        const enabled = !state.resale.magicEnabled;
        setBusy($("magicToggleBtn"), true, enabled ? "Turning ON..." : "Turning OFF...");
        try {
          await api("/api/resale/magic-mode", {
            method: "POST",
            body: { client, enabled }
          });
          await refreshSummary();
          toast("ok", "Magic mode " + (enabled ? "enabled" : "disabled") + ".");
        } finally {
          setBusy($("magicToggleBtn"), false);
        }
      }

      async function importResaleLeadsQuick() {
        const client = $("clientInput").value.trim() || "default";
        const sampleCsv = [
          "name,phone,last_message_date,property_interested,notes",
          "Vishal,+919812345678,2026-02-01,2 BHK Wakad,asked for brochure",
          "Priya,+919812345679,2026-01-10,3 BHK Baner,site visit pending",
          "Rahul,+919812345680,2025-12-20,2 BHK Kharadi,budget discussion"
        ].join("\n");
        setBusy($("importResaleBtn"), true, "Importing...");
        try {
          const out = await api("/api/resale/import", {
            method: "POST",
            body: { client, csv: sampleCsv, queueMagic: true }
          });
          addMessage("agent", "Resale import complete: " + out.imported + " leads, queued " + (out.queued?.queued || 0) + " nurture actions.");
          await refreshSummary();
          toast("ok", "Leads imported.");
        } finally {
          setBusy($("importResaleBtn"), false);
        }
      }

      async function shareWinCard() {
        const share = state.resale.share;
        if (!share) {
          toast("warn", "No win card data yet. Enable Magic Mode and refresh.");
          return;
        }
        const text = [share.title, ...(share.lines || [])].join("\n");
        try {
          if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
          toast("ok", "Win card copied.");
        } catch {
          toast("warn", "Clipboard unavailable. Showing win card in chat.");
        }
        addMessage("agent", text);
      }

      async function refreshSessions() {
        const ticket = ++state.req.sessions;
        const client = $("clientInput").value.trim() || "default";
        const box = $("sessionList");
        const boxDash = $("sessionListDashboard");
        box.innerHTML = "<div class='empty'>Loading sessions...</div>";
        boxDash.innerHTML = "<div class='empty'>Loading sessions...</div>";
        try {
          const out = await api("/api/sessions?client=" + encodeURIComponent(client));
          if (ticket !== state.req.sessions) return;
          box.innerHTML = "";
          boxDash.innerHTML = "";
          if (!(out.sessions || []).length) {
            box.innerHTML = "<div class='empty'>No recent sessions.</div>";
            boxDash.innerHTML = "<div class='empty'>No recent sessions.</div>";
            return;
          }
          for (const s of out.sessions || []) {
            const row = document.createElement("button");
            row.type = "button";
            row.className = "sessionItem";
            row.innerHTML = "<div><strong>" + escapeHtml(s.id) + "</strong></div><div class='mono'>" +
              escapeHtml(s.language + " | msgs " + s.messages + " | " + (s.lastUsedAt || "")) + "</div>";
            row.onclick = () => startSession({ sessionId: s.id, language: s.language || "en" }).catch((err) => toast("err", err.message));
            box.appendChild(row);
            boxDash.appendChild(row.cloneNode(true));
            boxDash.lastChild.onclick = row.onclick;
          }
        } catch (err) {
          if (ticket === state.req.sessions) {
            box.innerHTML = "<div class='empty'>Could not load sessions.</div>";
            boxDash.innerHTML = "<div class='empty'>Could not load sessions.</div>";
          }
          throw err;
        }
      }

      async function refreshCampaigns() {
        const client = $("clientInput").value.trim() || "default";
        const box = $("campaignList");
        box.innerHTML = "<div class='empty'>Loading campaigns...</div>";
        const out = await api("/api/campaigns?client=" + encodeURIComponent(client)).catch(() => ({ campaigns: [] }));
        state.campaigns = Array.isArray(out?.campaigns) ? out.campaigns : [];
        if (!state.campaigns.length) {
          box.innerHTML = "<div class='empty'>No campaigns found.</div>";
          return;
        }
        box.innerHTML = "";
        for (const c of state.campaigns) {
          const row = document.createElement("div");
          row.className = "sessionItem";
          row.innerHTML = "<div><strong>" + escapeHtml(c.name || c.id || "Campaign") + "</strong></div><div class='mono'>" +
            escapeHtml("template " + String(c.template || c.template_name || "-") + " | status " + String(c.status || "pending")) + "</div>";
          box.appendChild(row);
        }
      }

      async function createCampaign() {
        const client = $("clientInput").value.trim() || "default";
        const name = $("campaignName").value.trim();
        const template = $("campaignTemplate").value.trim();
        const recipients = $("campaignRecipients").value.trim().split(",").map((v) => v.trim()).filter(Boolean);
        const scheduleRaw = $("campaignSchedule").value;
        if (!name || !template || !recipients.length) {
          toast("warn", "Enter campaign name, template and recipients.");
          return;
        }
        const payload = { client, name, template, recipients };
        if (scheduleRaw) payload.scheduleAt = new Date(scheduleRaw).toISOString();
        await api("/api/campaigns", { method: "POST", body: payload });
        toast("ok", "Campaign created.");
        $("campaignName").value = "";
        $("campaignRecipients").value = "";
        $("campaignSchedule").value = "";
        await refreshCampaigns();
      }

      async function refreshSettings() {
        const cfg = await api("/api/config").catch(() => ({}));
        const health = await api("/api/health").catch(() => ({}));
        $("webhookUrl").textContent = String(cfg?.webhookUrl || cfg?.webhook_url || "Not configured");
        $("gatewayHealth").textContent = health?.ok ? "Healthy" : "Unknown";
        $("configSnapshot").value = JSON.stringify(cfg || {}, null, 2);
        if (cfg?.aiProvider) $("aiProvider").value = cfg.aiProvider;
        if (cfg?.aiModel) $("aiModel").value = cfg.aiModel;
        if (cfg?.aiBaseUrl) $("aiBaseUrl").value = cfg.aiBaseUrl;
        await refreshMetaCredentials();
      }

      async function refreshMetaCredentials() {
        const client = $("clientInput").value.trim() || "default";
        const creds = await api("/api/clients/" + encodeURIComponent(client) + "/credentials").catch(() => ({}));
        $("metaToken").value = "";
        $("metaPhoneId").value = String(creds?.phoneNumberId || "");
        $("metaWabaId").value = String(creds?.wabaId || "");
        $("metaTokenHint").textContent = creds?.hasToken
          ? ("Saved token: " + String(creds?.tokenMasked || "***"))
          : "No token saved for this client";
      }

      async function saveMetaCredentials() {
        const client = $("clientInput").value.trim() || "default";
        const token = $("metaToken").value.trim();
        const phoneNumberId = $("metaPhoneId").value.trim();
        const wabaId = $("metaWabaId").value.trim();
        if (!token || !phoneNumberId || !wabaId) {
          toast("warn", "Enter token, phone number ID, and WABA ID.");
          return;
        }
        await api("/api/clients/" + encodeURIComponent(client) + "/credentials", {
          method: "POST",
          body: { token, phoneNumberId, wabaId, makeActive: true }
        });
        $("metaToken").value = "";
        toast("ok", "Meta credentials saved.");
        await Promise.all([loadConfig(), refreshSettings()]);
      }

      async function loadConfig() {
        try {
          const cfg = await api("/api/config");
          if (cfg?.activeClient) $("clientInput").value = cfg.activeClient;
          if (cfg?.language) $("langInput").value = cfg.language;
          if (cfg?.aiProvider) $("aiProvider").value = cfg.aiProvider;
          if (cfg?.aiModel) $("aiModel").value = cfg.aiModel;
          if (cfg?.aiBaseUrl) $("aiBaseUrl").value = cfg.aiBaseUrl;
        } catch {}
      }

      function loadLocalAiSettings() {
        try {
          const raw = localStorage.getItem("waba.ai.settings");
          if (!raw) return;
          const obj = JSON.parse(raw);
          if (obj?.provider) $("aiProvider").value = obj.provider;
          if (obj?.model) $("aiModel").value = obj.model;
          if (obj?.baseUrl) $("aiBaseUrl").value = obj.baseUrl;
        } catch {}
      }

      async function saveAiSettings() {
        const provider = $("aiProvider").value;
        const model = $("aiModel").value.trim();
        const baseUrl = $("aiBaseUrl").value.trim();
        const apiKey = $("aiApiKey").value.trim();
        if (!model) {
          toast("warn", "Model is required.");
          return;
        }
        if (provider !== "ollama" && !apiKey) {
          toast("warn", "API key is required for this provider.");
          return;
        }
        const out = await api("/api/config/ai", {
          method: "POST",
          body: { provider, model, baseUrl, apiKey }
        });
        localStorage.setItem("waba.ai.settings", JSON.stringify({ provider, model, baseUrl }));
        toast("ok", "AI settings saved to backend.");
        $("aiApiKey").value = "";
        if (out?.aiProvider) $("aiProvider").value = out.aiProvider;
        if (out?.aiModel) $("aiModel").value = out.aiModel;
        if (out?.aiBaseUrl) $("aiBaseUrl").value = out.aiBaseUrl;
        await refreshSettings();
      }

      $("startBtn").onclick = () => startSession().then(() => setView("chat")).catch(err => toast("err", err.message));
      $("refreshBtn").onclick = () => Promise.all([refreshSummary(), refreshSessions(), refreshCampaigns(), refreshSettings()]).catch(err => toast("err", err.message));
      $("magicToggleBtn").onclick = () => toggleMagicMode().catch(err => toast("err", err.message));
      $("importResaleBtn").onclick = () => importResaleLeadsQuick().catch(err => toast("err", err.message));
      $("sendBtn").onclick = () => sendMessage().catch(err => toast("err", err.message));
      $("execAllBtn").onclick = () => executeAll().catch(err => toast("err", err.message));
      $("clearActionsBtn").onclick = () => { state.actions = []; renderActions(); toast("warn", "Queue cleared locally."); };
      $("createCampaignBtn").onclick = () => createCampaign().catch(err => toast("err", err.message));
      $("saveAiBtn").onclick = () => saveAiSettings().catch(err => toast("err", err.message));
      $("reloadSettingsBtn").onclick = () => refreshSettings().catch(err => toast("err", err.message));
      $("saveMetaBtn").onclick = () => saveMetaCredentials().catch(err => toast("err", err.message));
      $("reloadMetaBtn").onclick = () => refreshMetaCredentials().catch(err => toast("err", err.message));
      $("openMetaAppBtn").onclick = () => window.open(META_APP_URL, "_blank", "noopener");
      $("openMetaApiBtn").onclick = () => window.open(META_TOKEN_URL, "_blank", "noopener");
      $("openMetaBizBtn").onclick = () => window.open("https://business.facebook.com/settings", "_blank", "noopener");
      $("copyMetaCmdBtn").onclick = async () => {
        const client = $("clientInput").value.trim() || "default";
        const cmd = `waba clients add ${client} --token "<TOKEN>" --phone-id "<PHONE_ID>" --business-id "<WABA_ID>" --switch`;
        try {
          if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(cmd);
          toast("ok", "Meta setup command copied.");
        } catch {
          toast("warn", "Clipboard unavailable. Command added to chat.");
          addMessage("agent", cmd);
        }
      };
      $("quickMetaLaunchBtn").onclick = () => {
        setView("settings");
        window.open(META_TOKEN_URL, "_blank", "noopener");
      };
      $("quickMetaLaunchTopBtn").onclick = () => $("quickMetaLaunchBtn").click();
      $("quickMetaCmdBtn").onclick = () => $("copyMetaCmdBtn").click();

      $("openChatBtn").onclick = () => setView("chat");
      $("openCampaignsBtn").onclick = () => setView("campaigns");
      $("openSettingsBtn").onclick = () => setView("settings");
      $("refreshDashBtn").onclick = () => Promise.all([refreshSummary(), refreshSessions()]).then(() => toast("ok", "Refreshed.")).catch(err => toast("err", err.message));

      for (const btn of document.querySelectorAll(".tab")) {
        btn.onclick = () => setView(btn.dataset.view);
      }

      $("msgInput").addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          sendMessage().catch(err => toast("err", err.message));
        }
      });
      $("allowHighRisk").addEventListener("change", (ev) => {
        toast(ev.target.checked ? "warn" : "ok", ev.target.checked ? "High-risk execution enabled." : "High-risk execution disabled.");
      });

      (async () => {
        try {
          loadLocalAiSettings();
          await loadConfig();
          clearChatWithEmpty("Initializing gateway session...");
          renderActions();
          setView("dashboard");
          await startSession();
          await Promise.all([refreshCampaigns(), refreshSettings()]);
          setInterval(() => refreshSummary().catch(() => {}), 25000);
        } catch (err) {
          addMessage("agent", "Gateway init failed: " + err.message);
          toast("err", "Gateway init failed.");
        }
      })();
    </script>
</body>
</html>
